rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users can read their own user document and admins can read all
    match /users/{userId} {
      allow read: if request.auth != null && 
        (request.auth.uid == userId || 
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin");
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    match /notifications/{notificationId} {
      allow create: if request.auth != null;
      allow read: if request.auth != null && 
        resource.data.userId == request.auth.uid;
      allow update: if request.auth != null && 
        resource.data.userId == request.auth.uid;
    }
    // Requests rules
    match /requests/{requestId} {
      // Anyone authenticated can create requests (citizens)
      allow create: if request.auth != null;
      
      // Users can read requests if:
      // - They created it (citizen)
      // - They're assigned to it (volunteer)
      // - It's a submitted request (volunteers browsing available tasks)
      // - They're an admin
      allow read: if request.auth != null && 
        (resource.data.citizenId == request.auth.uid || 
         resource.data.volunteerId == request.auth.uid ||
         resource.data.status == "Submitted" ||
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin");
      
      // Volunteers can update requests they're assigned to
      // OR volunteers can update submitted requests to assign themselves
      // Admins can update any request
      allow update: if request.auth != null && 
        (
          // Volunteer is already assigned to this request
          resource.data.volunteerId == request.auth.uid ||
          
          // Volunteer is trying to assign themselves to a submitted request
          (
            resource.data.status == "Submitted" && 
            request.auth.uid != null &&
            // Make sure the update only sets volunteerId and status fields
            request.resource.data.volunteerId == request.auth.uid &&
            request.resource.data.status == "Assigned" &&
            // Preserve other important fields
            request.resource.data.citizenId == resource.data.citizenId &&
            request.resource.data.type == resource.data.type &&
            request.resource.data.description == resource.data.description &&
            request.resource.data.location == resource.data.location
          ) ||
          
          // Admin can update any request
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin"
        );
    }
  }
}